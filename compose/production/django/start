#!/bin/bash

set -o errexit
set -o pipefail
set -o nounset

# Optional verbose shell tracing in logs
if [ "${ENABLE_DEBUG_LOGS:-0}" = "1" ]; then
	set -x
fi


# Ensure we use production settings unless explicitly overridden
export DJANGO_SETTINGS_MODULE="${DJANGO_SETTINGS_MODULE:-config.settings.production}"

# Startup diagnostics (sanitized); disable by setting STARTUP_DIAGNOSTICS=0
if [ "${STARTUP_DIAGNOSTICS:-1}" = "1" ]; then
python - <<'PY'
import os
from urllib.parse import urlparse
print("=== Startup diagnostics ===")
print("DJANGO_SETTINGS_MODULE:", os.environ.get("DJANGO_SETTINGS_MODULE"))
sk = os.environ.get("DJANGO_SECRET_KEY", "")
print("SECRET_KEY set:", bool(sk), "length:", len(sk) if sk else 0)
db_url = os.environ.get("DATABASE_URL")
if db_url:
	p = urlparse(db_url)
	print(f"DATABASE: scheme={p.scheme} host={p.hostname} port={p.port} name={p.path.lstrip('/')} user={p.username}")
else:
	print("DATABASE_URL not set")
redis_url = os.environ.get("REDIS_URL")
if redis_url:
	r = urlparse(redis_url)
	print(f"REDIS: scheme={r.scheme} host={r.hostname} port={r.port} db={r.path.lstrip('/')}")
else:
	print("REDIS_URL not set")
try:
	from django.conf import settings
	print("ALLOWED_HOSTS:", getattr(settings, 'ALLOWED_HOSTS', []))
	print("DEBUG:", getattr(settings, 'DEBUG', None))
	print("ADMIN_URL:", getattr(settings, 'ADMIN_URL', 'admin/'))
except Exception as e:
	print("Could not import Django settings:", repr(e))
print("============================")
PY
fi

python /app/manage.py check --deploy --fail-level WARNING || true
python /app/manage.py migrate --noinput
python /app/manage.py collectstatic --noinput
python /app/manage.py setup_rbac

# Optionally start sshd (port 2222) for interactive access where supported.
# On platforms like Render this may fail (non-root, restricted env). Make it non-fatal.
if [ "${ENABLE_SSHD:-0}" = "1" ]; then
	if command -v /usr/sbin/sshd >/dev/null 2>&1; then
		/usr/sbin/sshd -D >/dev/null 2>&1 & || true
	else
		echo "sshd not available; skipping" >&2
	fi
fi

PORT="${PORT:-5000}"
# Tune Gunicorn for constrained environments (e.g., Render free/low-memory)
# Use WEB_CONCURRENCY or GUNICORN_WORKERS if provided; default to 2.
if [ -n "${WEB_CONCURRENCY:-}" ]; then
	WORKERS="${WEB_CONCURRENCY}"
else
	WORKERS="${GUNICORN_WORKERS:-2}"
fi

TIMEOUT="${GUNICORN_TIMEOUT:-60}"
MAX_REQUESTS="${GUNICORN_MAX_REQUESTS:-1000}"
MAX_REQUESTS_JITTER="${GUNICORN_MAX_REQUESTS_JITTER:-100}"
LOG_LEVEL="${GUNICORN_LOG_LEVEL:-info}"
ACCESS_LOG="${GUNICORN_ACCESS_LOGFILE:--}"
ERROR_LOG="${GUNICORN_ERROR_LOGFILE:--}"
KEEPALIVE="${GUNICORN_KEEPALIVE:-5}"
GRACEFUL_TIMEOUT="${GUNICORN_GRACEFUL_TIMEOUT:-30}"

exec /usr/bin/tini -- /usr/local/bin/gunicorn \
	config.asgi \
	--bind 0.0.0.0:"${PORT}" \
	--chdir=/app \
	-k uvicorn_worker.UvicornWorker \
	--workers "${WORKERS}" \
	--timeout "${TIMEOUT}" \
	--graceful-timeout "${GRACEFUL_TIMEOUT}" \
	--keep-alive "${KEEPALIVE}" \
	--max-requests "${MAX_REQUESTS}" \
	--max-requests-jitter "${MAX_REQUESTS_JITTER}" \
	--log-level "${LOG_LEVEL}" \
	--access-logfile "${ACCESS_LOG}" \
	--error-logfile "${ERROR_LOG}"
