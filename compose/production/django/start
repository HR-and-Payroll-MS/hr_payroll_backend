#!/bin/bash

set -o errexit
set -o pipefail
set -o nounset


python /app/manage.py migrate --noinput
python /app/manage.py collectstatic --noinput
python /app/manage.py setup_rbac

# Optionally start sshd (port 2222) for interactive access where supported.
# On platforms like Render this may fail (non-root, restricted env). Make it non-fatal.
if [ "${ENABLE_SSHD:-0}" = "1" ]; then
	if command -v /usr/sbin/sshd >/dev/null 2>&1; then
		/usr/sbin/sshd -D >/dev/null 2>&1 & || true
	else
		echo "sshd not available; skipping" >&2
	fi
fi

PORT="${PORT:-5000}"
# Tune Gunicorn for constrained environments (e.g., Render free/low-memory)
# Use WEB_CONCURRENCY or GUNICORN_WORKERS if provided; default to 2.
if [ -n "${WEB_CONCURRENCY:-}" ]; then
	WORKERS="${WEB_CONCURRENCY}"
else
	WORKERS="${GUNICORN_WORKERS:-2}"
fi

TIMEOUT="${GUNICORN_TIMEOUT:-60}"
MAX_REQUESTS="${GUNICORN_MAX_REQUESTS:-1000}"
MAX_REQUESTS_JITTER="${GUNICORN_MAX_REQUESTS_JITTER:-100}"
LOG_LEVEL="${GUNICORN_LOG_LEVEL:-info}"

exec /usr/bin/tini -- /usr/local/bin/gunicorn \
	config.asgi \
	--bind 0.0.0.0:"${PORT}" \
	--chdir=/app \
	-k uvicorn_worker.UvicornWorker \
	--workers "${WORKERS}" \
	--timeout "${TIMEOUT}" \
	--max-requests "${MAX_REQUESTS}" \
	--max-requests-jitter "${MAX_REQUESTS_JITTER}" \
	--log-level "${LOG_LEVEL}"
