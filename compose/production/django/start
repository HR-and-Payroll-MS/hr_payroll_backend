#!/bin/bash

set -o errexit
set -o pipefail
set -o nounset


python /app/manage.py migrate --noinput
python /app/manage.py collectstatic --noinput
python /app/manage.py setup_rbac

# Start sshd (runs on port 2222) for Azure interactive access; ignore failure to avoid blocking app
/usr/sbin/sshd -D &

PORT="${PORT:-5000}"
exec /usr/bin/tini -- /usr/local/bin/gunicorn config.asgi --bind 0.0.0.0:"${PORT}" --chdir=/app -k uvicorn_worker.UvicornWorker
