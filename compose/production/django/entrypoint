#!/bin/bash

set -o errexit
set -o pipefail
set -o nounset

if [ -z "${DATABASE_URL:-}" ]; then
    if [ -z "${POSTGRES_USER:-}" ]; then
            base_postgres_image_default_user='postgres'
            export POSTGRES_USER="${base_postgres_image_default_user}"
    fi
    export DATABASE_URL="postgres://${POSTGRES_USER}:${POSTGRES_PASSWORD}@${POSTGRES_HOST}:${POSTGRES_PORT}/${POSTGRES_DB}"
    wait-for-it "${POSTGRES_HOST}:${POSTGRES_PORT}" -t 30
    >&2 echo 'PostgreSQL is available'
else
    >&2 echo 'Using provided DATABASE_URL'
fi

# Execute the container's command (e.g., /start) passed via CMD.
# Fallback to /start if no args provided.
if [ "$#" -gt 0 ]; then
    exec "$@"
else
    exec /start
fi
